# 5장 서버측의 LAN 에는 무엇이 있는가?

핵심 포인트
방화벽과 캐시 서버

동작순서


---

## 1. 웹 서버의 설치 장소

<br>

### 1. 사내에 웹 서버를 설치하는 경우

- 라우터에서 직접 연결하는 경우
    * 사내에 LAN 서버를 설치하고 직접 인터넷에 액세스
    * IP 부족 이슈와 보안상의 이유로 현재는 잘 사용하지 않음
    * IP 부족 : 서버와 클라이언트에 모두 글로벌 주소를 할당해야 하는데 부족할 수 있음
    * 보안 이슈 : 인터넷에서 들어오는 패킷이 그대로 중계되는데 어플리케이션에 보안 구멍이 있다면 어플리케이션은 무방비상태가 된다.
    * 클라우드로 따지자면, 모든 서버에 EIP 를 붙이는 경우일까?

- 방화벽으로 분리하는 경우
    * 보안 이슈를 해결하기 위하여 방화벽을 통해 웹서버와 통신
    * 패킷을 검사하고 통과를 허용하는 패킷만 중계한다
    * 액세스가 허가된 어플리케이션에 보안 구멍이 있을 수 있기 때문에 완전히 위험이 없어지진 않는다.

<br>

### 2. 데이터 센터에 웹서버를 설치하는 경우

- 통신 회사의 데이터 센터에 설치하는 경우
    * 프로바이더가 운영하는 서버를 빌려쓰는 형태로 운영
    * 고속으로 액세스가 가능
    * 패킷이 인터넷 중심 부분에서 데이터 센터로 흘러가 서버에 도착한다.
    * 데이터 센터는 물리적으로 안전한 건물, 방화벽 설치 운영, 기기 가동 상태 감시, 부정 침입 감시 등의 부가 서비스를 제공하며 안정성이 높다


<br>

---

## 2. 방화벽의 원리와 동작

<br>

### 1. 패킷 필터형이 주류이다

- 방화벽은 특정 서버와 해당 서버 안의 특정 어플리케이션에 액세스 하는 패킷만 통과하고 나머지는 차단한다.

- 성능, 가격, 사용 편의성 등에 의해 패킷 필터링형 방화벽이 가장 많이 보급되어 있다.


<br>

### 2. 패킷 필터링의 조건 설정 개념

- 패킷의 헤더에 들어잇는 제어 정보를 통해 패킷 필터링 조건을 걸정한다. 이 조건에 따라서 액세스가 허가되지 않으면 해당 패킷을 차단한다.

- 패킷 헤더의 수신처 IP와 송신처 IP 로 종점과 시작점을 판단하여, 수신처가 해당 웹서버의 IP 주소와 일치하는 경우에만 패킷을 통과시킨다.

- 패킷이 들어온 후 을답 패킷을 다시 클라이언트에게 보내야 하기 때문에 웹서버에서 인터넷으로 나가는 패킷 중 송신처가 IP 가 본 서버 IP 인 경우 통과 시킨다.

<br>

### 3. 어플리케이션을 한정할 때 포트 번호를 사용한다.

- 서버에 보안에 취햑한 다양한 어플리케이션이 있는 경우, 웹 어플리ㅔ이션에 대한 패킷만 허용하고 나머지를 차단하는 방식으로 보안을 향상시킬 수 있다.


<br>

### 4. 컨트롤 비트로 접속 방향을 판단한다.

- 웹 서버에 기생하며 다른 서버에 바이러스를 감염시키는 경우가 많기 때문에 웹 서버 → 인터넷으로 가는 패킷을 차단한다. 그렇지만 패킷은 양방향 프로토콜로 소통하기 때문에 한쪽이 차단되면 소통할 수 없어진다.

- 웹 서버에서 시작되는 통신을 금지해야하는데, 그렇다고 웹 서버에서 나가는 모든 패킷을 차단할 수 없다. 프로토콜 소통이 전혀 되지 않기 때문이다.

- 액세스 방향을 판단하여 패킷을 필터링 해야한다 → TCP 헤더의 컨트롤 비트로 판단할 수 있다

- TCP 접속 시 최초 패킷만 컨트롤 비트의 SYN → 1, ACK → 0 이다.

- 웹 서버에서 인터넷으로 나가는 패킷 중 위와 같이 컨트롤 비트가 설정된 패킷을 차단하면 웹 서버에서 TCP 접속을 시작하여 인터넷으로 액세스하는 동작을 차단할 수 있다.

- 이외에도 헤더의 여러 제어 정보들을 활용해서 패킷을 차단시키고 통과시킬 수 있다.

- 통과시키는 것과 차단하는 것을 선별할 수 없는 경우도 있다.

- DNS 서버에 대한 액세스와 같이 UDP를 사용하는 경우 접속 단계 동작이 없으므로 필터링 할 수 없다.

<br>

### 5. 사내 LAN 에서 공개 서버용 LAN 으로 조건을 설정한다

- 공개 서버용 LAN과 사내 LAN 패킷 조건, 인터넷과 사내 LAN 패킷 조건도 잘 설정해야한다.

- 인터넷에서 흘러온 패킷이 무조건 공개 서버용 LAN에 유입되면 서버가 위험해진다.

- 


<br>

### 6. 밖에서 사내 LAN 으로 액세스 할 수 없다.

- 패킷 필터링형 방화벽은 주소 변환 기능도 가지고 있다. 패킷 필터링과 마찬가지로 패킷의 시작점과 종착점을 판단하여 주소변환이 필요한 경우 주소 변환을 하고 아니면 하지 않는다.

- 주소 변환을 하지 않으면 액세스할 수 없다. 적절한 주소와 포트를 찾지 못하기 때문이다. 따라서 자연스럽게 인터넷에서 사내 LAN에 접근할 수 없는 구조가 된다. (따로 패킷 조건을 설정하지 않아도 된다)

<br>

### 7. 방화벽을 통과한다.

- 방화벽은 차단하는 패킷에 대한 기록을 남긴다

- 통과 시킨 후에는 패킷을 라우터와 비슷하게 중계한다.

- 패킷 필터링은 라우터의 패킷 중계 기능 중 부가기능으로 볼 수 있는데 그 조건 설정이 복잡해지면서 전용 하드웨어나 소프트웨어가 등장한 것이다. 간단한 패킷 필터링을 사용하면 라우터를 방화벽으로 사용할 수도 있다.


<br>

### 8. 방화벽으로 막을 수 없는 공격

- 특수한 데이터에 의해 서버를 공격하는 경우, 방화벽은 헤더의 정보만으로 필터링하기 때문에 차단할 수 없다

- 이 경우 어플리케이션의 버그를 수정하거나 패킷의 내용을 조사하여 위험한 데이터를 차단하는 별도의 소프트웨어를 준비하는 것이다.

<br>

---

## 3. 복수 서버에 리퀘스트를 분배한 서버의 부하 분산

<br>

### 1. 처리 능력이 부족하면 복수 서버로 분산된다

- 대량의 패킷이 들어오게되면, 회선이 아무리 빨라도 처리능력에 한계가 온다. 이때 복수의 서버를 이용하여 한대의 서버에 몰리는 처리량을 줄이는 분산 처리를 할 수 있다.

- DNS 서버에 IP 주소를 같은 이름으로 여러개 등록하면 DNS 서버는 조회때마다 라운드 로빈으로 IP 를 응답하여 액세스를 균등하게 분산시킨다.

- 또한 복수의 페이지가 하나의 로직을 수행할 수 있는데 매 요청마다 다른 서버가 응답하면 로직이 이어지지 않을 수 있다.

- 그래서 LB 로 여러대의 서버를 연결하는 경우, 세션 클러스터링을 주의해야 한다.

<br>

### 2. 부하 분산 장치를 이용해 복수의 웹 서버로 분할된다

- DNS 서버에 LB의 IP 를 등록하면, LB에서 등록하면 LB에 연결된 서버로 분산된다.

- sticky session 을 통해 이전 요청과 같은 서버로 요청을 보내도록 한다.

- 현재는 HTTP 헤더 필드에 정보를 추가할 수 있도록 하거나 데이터가 전후 관계를 확인할 수 있는 정보를 부가하는 방법을 사용한다.

- 판단하기 위해서 웹 서버에서 정보를 유지해야하지만 그럼 웹 서버에 부담이 간다.

<br>

---

## 4. 캐시 서버를 이용한 서버의 부하 분산

<br>

### 1. 캐시 서버의 이용

- 프록시 구조를 사용하여 데이터를 캐시에 저장한다.

- 프록시는 웹 서버와 클라이언트 사이에 들어가서 웹서버에 대한 액세스 동작을 중개한다.

- 중개하는 과정에서 웹 서버에서 받은 데이터를 저장해 두고 가능하면 해당 데이터를 대신하여 응답한다.

- 웹 서버가 처리해야할 일을 실행하기 위해서 오랜 시간이 걸리는 반면 캐시 서버는 받은 데이터를 곧바로 송신만 하면 되기 때문에 매우 빠르다.

- 데이터가 자주 바뀌는 부분은 캐시 서버를 활용하기 어렵다. 하지만 캐시 서버에서 처리할 수 이쓴ㄴ 얼마를 담당하면 웹 서버에 가는 부하도 줄어들어 처리 속도도 향상된다.

<br>

### 2. 캐시 서버는 갱신일로 콘텐츠를 관리한다

- 캐시 서버가 동작할 때 캐시 서버를 웹 서버 대신 DNS에 등록한다. 따라서 요청이 오면 캐시 서버가 대신해서 데이터를 받는다.

- 메세지를 받을 때 웹 서버의 수신 동작과 동일한 절차를 거쳐서 받는다.

- 패킷을 만들고, 접속 동작을 실행하고 요청 메세지를 받는다.

- 이후 해당 요청에 대한 데이터가 저장되어 있는지 조사한다.

- 저장된 데이터가 없는 경우 Via 라는 필드 값을 헤더에 추가하여 캐시 서버를 경유했다는 것을 나타낸다.

- 만일 여러대의 서버가 캐시 서버에 연결이 되어 있다면 요청의 URI에 따라서 웹 서버로 요청을 전송한다. 이때 클라이언트는 캐시 서버로 변경된다.

- 웹 서버에서 캐시 서버로 응답을 보내고 캐시 서버는 Via 헤더를 추가하여 클라이언트에게 응답을 한다.

- 그리고 응답에 대한 메시지를 캐시 서버에 저장하고 저장한 일시를 기록한다.

- 데이터가 저장되어 있는 경우 만일 캐시 데이터가 저장되어 있다면 해당 데이터가 변경 되지는 않았는지 확인하는 If-Modified-Since 헤더를 덧붙여서 웹 서버에 전송한다.

- 만일 데이터가 없었다면 위 헤더는 추가되지 않는다.

- 이때 웹 서버는 변경이 없다면 304 Not Modified 상태코드를 응답한다. 변경이 있다면 데이터가 없던 것과 마찬가지로 동작한다.

<br>

### 3. 프록시의 원점은 포워드 프록시이다

- 포워드 프록시는 클라이언트측에 캐시 서버를 두는 경우이다. 

- 웹 서버에 대한 캐시 서버와 동일하게 동작하지만 추가로 방화벽을 실현하는 목적이 있었다.

- 방화벽은 인터넷에서의 부정침입을 막는 것이기 때문에 프록시에서 요청 메세지를 받아 인터넷으로 필요한 것을 통과시키는 역할을 한다.

- 프록시의 캐시를 이용하면 사내 LAN에서 더 빨리 데이터를 얻을 수 있다.

- 프록시를 사용하면 요청의 내용을 조사하기 때문에 더 자세한 조건을 설정해서 특정 사이나에 대한 액세스를 금지하는 등의 제한을 걸 수 있다.

- 포워드 프록시 사용시 데이터 송신은 요청 메세지의 URL과 관계없이 모든 요청을 포워드 프록시에 우선 송신한다. 요청 메세지의 내용도 변경된다.

- 본래 웹 서버의 이름을 제외하고 URI에 데이터 경로를 적었는데, 포워드 프록시를 사용하는 경우 이름까지 그대로 요청 URL에 기록한다.

- URL에 적힌 그대로가 전송 대상이므로 서버측 캐시 서버와 같이 정해진 서버로 전송하는 것이 아니라 모든 서버에 전송할 수 있다.

<br>

### 4. 포워드 프록시를 개량한 리버스 프록시

- 포워드 프록시는 브라우저의 설정이 필요해 장애의 원인이 되기도 한다.

- 따라서 요청 메세지에 전체 URL이 아닌 URI 에 쓰여있는 디렉토리를 웹 서버에 대응시켜 전송할 수 있도록 했다 

- 서버측에 설치하는 캐시 서버에서 채택한 방법으로 리버스 프록시라고 한다.

<br>

### 5. 트랜스패어런트 프록시

- 캐시 서버에서 전송 대상을 판단하는 방법이다.

- IP 헤더의 수신처 IP 주소로 액세스 대상 웹 서버를 찾는 방법을 트랜스패어런트 프록시라고 한다.

- 포워드 프록시에서 처럼 브라우저에 설정할 필요도 없고 리버스 프록시처럼 전송 대상을 리버스 프록시로 설정하고 DNS에 등록할 필요도 없다.

- 만일 트랜스패어런트 프록시에 DNS에 등록된다면 수신처 IP가 해당 프록시가 되므로 수신처 IP를 조사해서 패킷을 중개하는 구조를 사용할 수 있다.

- 그래서 트랜스 패어런트 프록시를 브라우저에서 웹 서버로 요청 메세지가 흘러가는 길목에 설치하거나 한 길로 수렴하는 네트워크의 길목에 설치하여 사용한다. (길마다 프록시를 설치해야할 수도 있다)

<br>

---

## 5. 콘텐츠 배포 서비스

<br>

### 1. CDN 을 이용한 부하 분산

- 서버 측 캐시와 클라이언트 측 캐시의 부하 경감 효과가 각각 다르다.

- 서버 측 캐시는 웹 서버에 들어오는 요청에 대한 부하를 분산시킨다.

- 클라이언트 측 캐시는 인터넷에 들어오는 패킷 수를 줄여 인터넷 트래픽을 억제한다.

- 인터넷 트래픽을 억제하기 위해서는 (특히나 대용량 이미지나 영상 데이터에 대해) 클라이언트 측에 캐시 서버를 두는 것이 더 좋다. 하지만 그것은 웹 서버 개발자가 제어할 수 있는 부분이 아니다. (브라우저를 통한 설정이 필요하기 때문이다.)

- 따라서 해결책으로 프로바이더와 계약하여 웹 서버 개발자가 제어할 수 있는 클라이언트 가까이 있는 캐시 서버를 이용하는 것이다. → CDN

- 모든 프로바이더에 캐시 서버를 설치하는 것은 어려우니 우선 중요한 프로바이더마다 캐시 서버를 설치한다.

- 서버 운영자가 직접 설치하고 프로바이더와 계약하는 것이 어려우므로 그것을 대신 하고 캐시 서버를 대출하는 CDN 서비스가 등장했다.

- CDN 서버는 여러 웹 서버의 데이터를 캐싱할 수 있으므로 여러 웹 서버 개발자들이 공동으로 이용하여 이용 비용을 절감할 수 있다.

<br>

### 2. 가장 가까운 캐시 서버의 관점

- CDN을 사용하기 위해서는 클라이언트가 가장 가까운 캐시 서버를 찾을 수 있어야한다.

- DNS 서버가 IP주소를 응답할 때 가장 가까운 캐시 서버의 IP 주소를 응답하도록 설정한다.

- DNS 서버에서 복수의 IP가 등록된 경우 RR로 응답하는 것을 변경한다.

- 응답할 때 RR 방식이 아니라 클라이언트와 캐시 서버의 거리를 판단하여 가장 가까운 캐시 서버 IP를 반환하도록 한다.

- 캐시 서버의 설치 장소에 있는 라우터에서 경로 정보를 모은다. (캐시 서버 갯수만큼의 경로표가 모인다)

- 웹 서버 측 DNS 서버에서 해당 경로표를 입수하여 클라이언트의 DNS 요청 패킷의 송신처 IP주소와의 경로 및 거리를 측정한다.

- 이때 클라이언트 측 DNS 서버와의 거리를 측정하기 때문에 대략적인 거리이다.

- 인터넷 경로 정보에 지나는 프로바이더와 대략적인 거리 정보가 있다.

- 클라이언트 DNS 서버와 가장 가까운 캐시의 라우터를 알 수 있다.

<br>

### 3. 리피터용 서버로 엑세스 대상을 분배한다

- 리다이렉트를 나타내는 Location 필드를 사용하여 액세스 대상을 가장 가까운 캐시 서버로 돌리는 방법이다.

- 먼저 DNS 서버에서 웹 서버의 IP주소를 회답하고 클라이언트가 해당 IP 주소(리다이렉트용 서버)로 요청을 보낸다. 리다이렉트용 서버는 경로표를 가지고 있어 가장 가까운 캐시 서버로 리다이렉트 하도록 Location 필드를 설정하여 응답한다.

- HTTP 요청이 많아지므로 어느정도 오버헤드가 있다. 하지만 클라이언트 DNS 서버와의 거리가 아닌 클라이언트 간의 거리를 조사하므로 더 정확하다.

- 더 정확하게 하기 위해 최적의 캐시 서버에 액세스하는 스크립트 프로그램을 내장한 페이지를 반송할 수도 있다.

<br>

### 4. 캐시 내용의 갱신 방법에서 성능의 차이가 난다

- 캐시서버를 이용할 때 갱신 내용 유무를 확인하느라 네트워크가 혼잡해질 수도 있다.

- 이 점을 개선하기 위해 확인을 하지 않고 데이터가 업데이트 된다면 즉시 갱신할 수 있다.

- CDN 캐시 서버에는 이러한 기능이 내장되어 있다.

- 캐시에는 변하지 않는 부분만 캐싱하는 것이 효율적이다.

<br>
